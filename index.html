<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>My Personal Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    <style>
        :root {
            --body-bg: #f0f2f5;
            --chat-area-bg: #e9ecef;
            --user-bubble-bg: #007bff;
            --assistant-bubble-bg: #ffffff;
            --controls-bg: #ffffff;
            --border-color: #ced0d4;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--body-bg);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            color: #333;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            display: flex;
            flex-direction: column;
        }
        .modal-content input[type="password"], #edit-history-textarea {
            display: block;
            width: 90%;
            margin: 1.5rem auto;
            padding: 12px;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }
        #edit-history-textarea {
            text-align: left;
            font-size: 0.9rem;
            height: 40vh;
            resize: vertical;
        }
        .modal-button {
            padding: 10px 20px;
            font-size: 0.9rem;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
        }
        #api-key-modal-content p, #archive-modal-content p, #edit-modal-content p { font-size: 0.9rem; line-height: 1.5; color: #65676b; text-align: left; }
        #api-key-modal-content a { color: #007bff; text-decoration: none; font-weight: bold; }
        #api-key-modal-content a:hover { text-decoration: underline; }
        .button-container { display: flex; flex-direction: column; align-items: center; gap: 0.8rem; margin-top: 1.5rem; }
        #password-modal-content .button-container { width: 75%; margin-left: auto; margin-right: auto; }
        #password-button { background-color: #007bff; padding: 8px 16px; }
        #return-button { background-color: #6c757d; text-decoration: none; display: block; padding: 8px 16px; }
        #save-private-key-button, #save-edited-button { background-color: #007bff; }
        #donate-key-button { background-color: #28a745; }
        #close-api-key-modal, #close-archive-modal, #close-edit-modal { background-color: #6c757d; }
        #archive-list { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; text-align: left; }
        #archive-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #archive-list li:hover { background-color: #f0f2f5; }
        .delete-archive-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; opacity: 0.5; }
        .delete-archive-btn:hover { opacity: 1; color: #dc3545; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        .is-invalid { animation: shake 0.5s; }
        #app-container { width: 100%; height: 100%; max-width: 800px; margin: 0 auto; display: none; flex-direction: column; background-color: white; }
        #app-top-bar { display: flex; align-items: center; padding: 8px; background-color: var(--controls-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: relative; }
        #back-button { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; text-decoration: none; z-index: 1; }
        #back-button:hover { background-color: rgba(0,0,0,0.05); }
        #back-button svg { width: 24px; height: 24px; fill: #333; }
        #app-title { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); margin: 0; font-size: 1.1rem; color: #333; font-weight: 600; }
        #top-right-buttons { margin-left: auto; display: flex; align-items: center; gap: 4px; padding-right: 8px; }
        .top-bar-button { background: transparent; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem; }
        .top-bar-button:hover { background-color: rgba(0,0,0,0.05); }
        #tts-toggle-button svg { width: 24px; height: 24px; fill: #65676b; }
        #tts-toggle-button.is-muted svg { fill: #bec3c9; }

        #avatar-container { width: 100%; padding: 8px 0; background-color: var(--controls-bg); text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #avatar { width: 90%; max-width: 250px; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #message-list { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; background-color: var(--chat-area-bg); }
        .message-bubble { padding: 10px 14px; border-radius: 18px; max-width: 80%; line-height: 1.4; word-wrap: break-word; align-self: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-message { background-color: var(--user-bubble-bg); color: white; align-self: flex-end; }
        .assistant-message { background-color: var(--assistant-bubble-bg); color: #050505; }
        .assistant-message img { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
        
        #controls-container { padding: 8px; border-top: 1px solid var(--border-color); background: var(--controls-bg); flex-shrink: 0; }
        #attachment-preview-area { padding: 0 8px 8px 8px; display: none; }
        .attachment-preview { display: flex; align-items: center; background: #e9ecef; padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; }
        .attachment-preview span { margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .remove-attachment-btn { background: none; border: none; cursor: pointer; margin-left: auto; font-size: 1.2rem; padding: 0 5px; opacity: 0.6; }
        .remove-attachment-btn:hover { opacity: 1; }
        
        #chat-form { display: flex; align-items: center; }
        .chat-form-button { background-color: #007bff; width: 44px; height: 44px; font-size: 1.5rem; border-radius: 50%; margin-left: 8px; border: none; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #attachment-button { background-color: #17a2b8; font-size: 1.2rem; }
        #micButton.is-listening { background-color: #fa383e; }
        #export-button { background-color: #6c757d; }
        #userInput { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 18px; font-size: 1rem; background: #f0f2f5; }
    </style>
</head>
<body>
    <div id="password-modal" class="modal-overlay"> ... </div>
    <div id="api-key-modal" class="modal-overlay"> ... </div>
    <div id="archive-modal" class="modal-overlay"> ... </div>

    <!-- ZMIANA: Nowe okno do edycji i eksportu -->
    <div id="edit-modal" class="modal-overlay">
        <div id="edit-modal-content" class="modal-content">
            <h3>Edytuj i Eksportuj Rozmowƒô</h3>
            <p>Mo≈ºesz tutaj poprawiƒá lub skr√≥ciƒá transkrypcjƒô przed zapisaniem jej do pliku.</p>
            <textarea id="edit-history-textarea"></textarea>
            <div class="button-container">
                <button id="save-edited-button" class="modal-button">Zapisz i Pobierz</button>
                <button id="close-edit-modal" class="modal-button">Anuluj</button>
            </div>
        </div>
    </div>
    
    <div id="app-container">
        <div id="app-top-bar">
            <a href="https://0-skar.github.io/0/" id="back-button"> ... </a>
            <h2 id="app-title">Cyfrowy Kumpel</h2>
            <div id="top-right-buttons">
                <!-- ZMIANA: Przycisk eksportu/edycji -->
                <button id="edit-export-button" class="top-bar-button" title="Edytuj i eksportuj">üìù</button>
                <button id="import-button" class="top-bar-button" title="Importuj rozmowƒô">üìÇ</button>
                <button id="api-key-button" class="top-bar-button" title="ZarzƒÖdzaj kluczem API">üîë</button>
                <button id="tts-toggle-button" class="top-bar-button"></button>
            </div>
        </div>
        <div id="avatar-container"> ... </div>
        <div id="message-list"></div>
        <div id="controls-container">
            <div id="attachment-preview-area"></div>
            <form id="chat-form">
                <button type="button" id="attachment-button" class="chat-form-button" title="Za≈ÇƒÖcz plik (txt, jpg, png)">üìé</button>
                <input type="text" id="userInput" placeholder="Opisz za≈ÇƒÖczony plik lub zadaj pytanie...">
                <button type="button" id="micButton" class="chat-form-button">üé§</button>
            </form>
        </div>
    </div>
    <input type="file" id="file-input" style="display: none;" accept="image/jpeg,image/png,text/plain">

    <script>
        // ... (sta≈Çe i zmienne DOM, w tym nowe dla edycji) ...
        const editModal = document.getElementById('edit-modal');
        const editHistoryTextarea = document.getElementById('edit-history-textarea');
        const saveEditedButton = document.getElementById('save-edited-button');
        const closeEditModal = document.getElementById('close-edit-modal');
        const editExportButton = document.getElementById('edit-export-button');
        
        let conversationHistory = [];
        // ... (reszta zmiennych) ...

        // ... (funkcje displayInitialGreeting, checkAuthentication, etc. bez zmian) ...
        
        // ZMIANA: Ulepszona funkcja `generateImage` z kodowaniem Base64
        async function generateImage(prompt) {
            addMessageToChat("Chwileczkƒô, ju≈º siƒô biorƒô za malowanie... üé®", false, false);
            try {
                const fullUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
                const response = await fetch(fullUrl, { method: 'POST' });
                if (!response.ok) throw new Error(`B≈ÇƒÖd serwera malarskiego: ${response.statusText}`);
                
                const blob = await response.blob();
                
                // Konwertujemy obraz do Base64, aby mo≈ºna go by≈Ço zapisaƒá
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64data = reader.result;
                    addMessageToChat(`[IMG]${prompt}[/IMG]`, false, true, base64data);
                };
                reader.readAsDataURL(blob);

            } catch (error) {
                addMessageToChat("Ajj, co≈õ posz≈Ço nie tak i farby mi siƒô rozla≈Çy. üòï", false, false);
                console.error("B≈ÇƒÖd generowania obrazu:", error);
            }
        }
        
        // Funkcje Eksportu/Importu/Edycji
        function exportConversation(history) {
            const dataStr = JSON.stringify(history, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rozmowa-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function openEditModal() {
            if (conversationHistory.length === 0) {
                addMessageToChat("Nie ma czego edytowaƒá!", false, false);
                return;
            }
            // Formatujemy historiƒô do czytelnej formy
            const formattedText = conversationHistory.map(msg => {
                const prefix = msg.role === 'user' ? 'TY:' : 'AGENT:';
                if (msg.imageUrl) {
                    return `${prefix} [OBRAZ: ${msg.content.replace(/\[IMG\]/g, '')}]`;
                }
                return `${prefix} ${msg.content}`;
            }).join('\n\n');
            editHistoryTextarea.value = formattedText;
            editModal.style.display = 'flex';
        }

        function saveAndDownloadEdited() {
            const editedText = editHistoryTextarea.value;
            // Tutaj mo≈ºna by dodaƒá zaawansowane parsowanie, ale na razie zapisujemy surowy tekst
            // Proste podej≈õcie: tworzymy nowƒÖ historiƒô na podstawie edytowanego tekstu
            const newHistory = [{ role: 'system', content: 'Edytowana transkrypcja rozmowy' }, { role: 'user', content: editedText }];
            exportConversation(newHistory);
            hideEditModal();
        }
        
        function hideEditModal() { editModal.style.display = 'none'; }

        importButton.addEventListener('click', () => { /* kod importu bez zmian */ });
        editExportButton.addEventListener('click', openEditModal);
        closeEditModal.addEventListener('click', hideEditModal);
        saveEditedButton.addEventListener('click', saveAndDownloadEdited);

        async function handleSubmit(isRetry = false) {
            // ZMIANA: Zwiƒôkszamy "pamiƒôƒá" asystenta
            const historySlice = conversationHistory.slice(-30); 
            // ... (reszta kodu handleSubmit bez zmian, ale u≈ºywa `historySlice`)
        }
        
        // ZMIANA: addMessageToChat musi teraz obs≈Çugiwaƒá `base64`
        function addMessageToChat(text, isUser, addToHistory = true, imageUrl = null, isHidden = false) {
            if (addToHistory) {
                const historyEntry = { role: isUser ? 'user' : 'assistant', content: text };
                // Zapisujemy obraz jako dane base64, je≈õli istnieje
                if (imageUrl && imageUrl.startsWith('data:image')) {
                    historyEntry.imageUrl = imageUrl;
                }
                if (isHidden) historyEntry.isHidden = true;
                conversationHistory.push(historyEntry);
            }
            if (isHidden) return;
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${isUser ? 'user' : 'assistant'}-message`;
            const cleanText = text.replace(/\[\/?(PL|EN|DE|FR|ES|IMG)\]/gi, '');
            if (imageUrl) {
                const image = document.createElement('img');
                image.src = imageUrl;
                image.alt = cleanText;
                messageBubble.appendChild(image);
            } else {
                if (cleanText) messageBubble.innerText = cleanText;
            }
            if (cleanText || imageUrl) {
                messageList.appendChild(messageBubble);
                messageList.scrollTop = messageList.scrollHeight;
            }
        }
        
        // ... (reszta kodu bez zmian) ...
    </script>
</body>
</html>
