<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>My Personal Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js" defer></script>
    <style>
        :root {
            --body-bg: #f0f2f5;
            --chat-area-bg: #e9ecef;
            --user-bubble-bg: #007bff;
            --assistant-bubble-bg: #ffffff;
            --controls-bg: #ffffff;
            --border-color: #ced0d4;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--body-bg);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            color: #333;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            display: flex;
            flex-direction: column;
        }
        .modal-content input[type="password"], #edit-history-textarea {
            display: block;
            width: 90%;
            margin: 1.5rem auto;
            padding: 12px;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }
        #edit-history-textarea {
            text-align: left;
            font-size: 0.9rem;
            height: 40vh;
            resize: vertical;
            font-family: "Courier New", Courier, monospace;
        }
        .modal-button {
            padding: 10px 20px;
            font-size: 0.9rem;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
        }
        #api-key-modal-content p, #edit-modal-content p { font-size: 0.9rem; line-height: 1.5; color: #65676b; text-align: left; }
        #api-key-modal-content a { color: #007bff; text-decoration: none; font-weight: bold; }
        #api-key-modal-content a:hover { text-decoration: underline; }
        .button-container { display: flex; flex-direction: column; align-items: center; gap: 0.8rem; margin-top: 1.5rem; }
        #password-modal-content .button-container { width: 75%; margin-left: auto; margin-right: auto; }
        #password-button { background-color: #007bff; padding: 8px 16px; }
        #return-button { background-color: #6c757d; text-decoration: none; display: block; padding: 8px 16px; }
        #save-private-key-button, #save-edited-button { background-color: #007bff; }
        #donate-key-button { background-color: #28a745; }
        #close-api-key-modal, #close-edit-modal { background-color: #6c757d; }
        
        pre[class*="language-"] {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 1em;
            margin: .5em 0;
            overflow: auto;
            position: relative;
        }
        .copy-code-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #5f5f5f;
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
        }
        .copy-code-button:hover { opacity: 1; }
        .download-file-button {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        .is-invalid { animation: shake 0.5s; }
        #app-container { width: 100%; height: 100%; max-width: 800px; margin: 0 auto; display: none; flex-direction: column; background-color: white; }
        #app-top-bar { display: flex; align-items: center; padding: 8px; background-color: var(--controls-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: relative; }
        #back-button { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; text-decoration: none; z-index: 1; }
        #back-button:hover { background-color: rgba(0,0,0,0.05); }
        #back-button svg { width: 24px; height: 24px; fill: #333; }
        #app-title { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); margin: 0; font-size: 1.1rem; color: #333; font-weight: 600; }
        #top-right-buttons { margin-left: auto; display: flex; align-items: center; gap: 4px; padding-right: 8px; }
        .top-bar-button { background: transparent; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem; }
        .top-bar-button:hover { background-color: rgba(0,0,0,0.05); }
        #tts-toggle-button svg { width: 24px; height: 24px; fill: #65676b; }
        #tts-toggle-button.is-muted svg { fill: #bec3c9; }
        #export-menu-container { position: relative; }
        #export-options { display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10; min-width: 150px;}
        #export-options a { display: block; padding: 8px 12px; text-decoration: none; color: #333; font-size: 0.9rem; }
        #export-options a:hover { background-color: #f0f2f5; }

        #avatar-container { width: 100%; padding: 8px 0; background-color: var(--controls-bg); text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #avatar { width: 90%; max-width: 250px; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #message-list { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; background-color: var(--chat-area-bg); }
        .message-bubble { padding: 10px 14px; border-radius: 18px; max-width: 80%; line-height: 1.4; word-wrap: break-word; align-self: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-message { background-color: var(--user-bubble-bg); color: white; }
        .assistant-message { background-color: var(--assistant-bubble-bg); color: #050505; }
        .assistant-message img { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
        
        /* === NOWE STYLE DLA WSKAÅ¹NIKA AKTYWNOÅšCI === */
        .loading-bubble {
            display: flex;
            align-items: center;
        }
        .loading-bubble span {
            display: block;
            width: 8px;
            height: 8px;
            background-color: #8e8e93;
            border-radius: 50%;
            margin: 0 2px;
            animation: pulse 1.4s infinite;
        }
        .loading-bubble span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-bubble span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes pulse {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        
        #controls-container { padding: 8px; border-top: 1px solid var(--border-color); background: var(--controls-bg); flex-shrink: 0; }
        #chat-form { display: flex; align-items: center; }
        .chat-form-button { background-color: #007bff; width: 44px; height: 44px; font-size: 1.5rem; border-radius: 50%; margin-left: 8px; border: none; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        
        #attachment-button {
            background: transparent;
            color: #65676b;
            font-size: 1.5rem;
            border-radius: 0;
            width: auto;
            height: auto;
            margin: 0 8px 0 4px;
            padding: 0;
            cursor: pointer;
            border: none;
        }

        #micButton.is-listening { background-color: #fa383e; }
        #userInput { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 18px; font-size: 1rem; background: #f0f2f5; }
    </style>
</head>
<body>
    <div id="password-modal" class="modal-overlay">
        <div id="password-modal-content" class="modal-content">
            <h3>Wpisz kod dostÄ™pu</h3>
            <input type="password" id="password-input">
            <div class="button-container">
                <button id="password-button" class="modal-button">WejdÅº</button>
                <a href="https://0-skar.github.io/0/" id="return-button" class="modal-button">WrÃ³Ä‡</a>
            </div>
        </div>
    </div>

    <div id="api-key-modal" class="modal-overlay">
        <!-- ... (bez zmian) ... -->
    </div>

    <div id="edit-modal" class="modal-overlay">
        <!-- ... (bez zmian) ... -->
    </div>
    
    <div id="app-container">
        <div id="app-top-bar">
            <!-- ... (bez zmian) ... -->
        </div>
        <div id="avatar-container">
            <!-- ... (bez zmian) ... -->
        </div>
        <div id="message-list"></div>
        <div id="controls-container">
            <form id="chat-form">
                <button type="button" id="attachment-button" class="chat-form-button" title="ZaÅ‚Ä…cz plik">ðŸ“Ž</button>
                <input type="text" id="userInput" placeholder="Opisz zaÅ‚Ä…czony plik lub zadaj pytanie..." autocomplete="off">
                <button type="button" id="micButton" class="chat-form-button">ðŸŽ¤</button>
            </form>
        </div>
    </div>
    <input type="file" id="file-input" style="display: none;" accept="image/jpeg,image/png,text/plain,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document">

    <script>
        // ... (wszystkie staÅ‚e i selektory bez zmian) ...
        const ACCESS_CODE = "2017";
        const BASE_BACKEND_URL = "https://eosforus-3.hf.space"; 
        const CHAT_URL = `${BASE_BACKEND_URL}/chat`;
        const DONATE_URL = `${BASE_BACKEND_URL}/donate-key`;
        const EXPORT_PDF_URL = `${BASE_BACKEND_URL}/export-pdf`;
        const IMAGE_BACKEND_URL = "https://image.pollinations.ai/prompt/";
        
        const AVATAR_STILL_URL = "https://raw.githubusercontent.com/0-skar/4/main/avatar-still.png";
        const AVATAR_TALKING_URL = "https://raw.githubusercontent.com/0-skar/4/main/avatar-talking.gif";
        const GREETINGS = [ "Siema. Co tam dziÅ› scrollujesz zamiast robiÄ‡ coÅ› poÅ¼ytecznego? ðŸ˜‰", "Elo. Zasilanie wÅ‚Ä…czone. GotÃ³w na marnowanie czasu w necie?", "CzeÅ›Ä‡. W co dzisiaj grasz? A moÅ¼e chcesz, Å¼ebym coÅ› namalowaÅ‚? ðŸ˜Ž" ];

        const appContainer = document.getElementById('app-container');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordButton = document.getElementById('password-button');
        const userInput = document.getElementById('userInput');
        const messageList = document.getElementById('message-list');
        const micButton = document.getElementById('micButton');
        const avatar = document.getElementById('avatar');
        const ttsToggleButton = document.getElementById('tts-toggle-button');
        const chatForm = document.getElementById('chat-form');
        const apiKeyModal = document.getElementById('api-key-modal');
        const userApiKeyInput = document.getElementById('user-api-key-input');
        const savePrivateKeyButton = document.getElementById('save-private-key-button');
        const donateKeyButton = document.getElementById('donate-key-button');
        const closeApiKeyModal = document.getElementById('close-api-key-modal');
        const apiKeyButton = document.getElementById('api-key-button');
        const attachmentButton = document.getElementById('attachment-button');
        const fileInput = document.getElementById('file-input');
        const editModal = document.getElementById('edit-modal');
        const editHistoryTextarea = document.getElementById('edit-history-textarea');
        const saveEditedButton = document.getElementById('save-edited-button');
        const closeEditModal = document.getElementById('close-edit-modal');
        const exportButtonMain = document.getElementById('export-button-main');
        const exportOptions = document.getElementById('export-options');
        const importJsonBtn = document.getElementById('import-json');
        const exportJsonBtn = document.getElementById('export-json');
        const exportPdfBtn = document.getElementById('export-pdf');
        const editExportButton = document.getElementById('edit-export-button');
        
        const synth = window.speechSynthesis;
        let voices = [];
        let isTtsEnabled = true;
        let conversationHistory = [];
        let lastUserMessage = "";

        // ... (wszystkie funkcje aÅ¼ do handleSubmit bez zmian) ...
        function displayInitialGreeting() { /*...*/ }
        function checkAuthentication() { /*...*/ }
        function initSpeechSynthesis() { /*...*/ }
        function handlePasswordAttempt() { /*...*/ }
        //...
        function downloadPdfFromBase64(filename, base64Data) { /*...*/ }


        // === ZAKTUALIZOWANA FUNKCJA handleSubmit Z INDYKATOREM ===
        async function handleSubmit(isRetry = false) {
            if (!sessionStorage.getItem('isAuthenticated')) return;
            let userText;
            if (isRetry) {
                userText = lastUserMessage;
            } else {
                userText = userInput.value.trim();
                const lastMessage = conversationHistory[conversationHistory.length - 1];
                if (!userText && !(lastMessage && lastMessage.attachments)) return;
                lastUserMessage = userText;
                if(userText || !(lastMessage && lastMessage.attachments)) {
                    addMessageToChat(userText, true);
                }
                userInput.value = '';
            }
            
            // --- NOWA LOGIKA: POKAÅ» WSKAÅ¹NIK ---
            const thinkingBubble = document.createElement('div');
            thinkingBubble.id = 'thinking-bubble';
            thinkingBubble.className = 'message-bubble assistant-message loading-bubble';
            thinkingBubble.innerHTML = '<span></span><span></span><span></span>';
            messageList.appendChild(thinkingBubble);
            messageList.scrollTop = messageList.scrollHeight;
            
            const historySlice = conversationHistory.slice(-30);
            const requestBody = { history: historySlice };
            
            const userKey = sessionStorage.getItem('userProvidedApiKey');
            if (userKey) { requestBody.apiKey = userKey; }

            try {
                const response = await fetch(CHAT_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(requestBody) 
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData.all_keys_exhausted) { showApiKeyModal(); } 
                    else { throw new Error(errorData.detail || 'Nieznany bÅ‚Ä…d serwera'); }
                    return;
                }
                const data = await response.json();

                if (data.image_file) {
                    addMessageToChat(`Oto Twoje zedytowane zdjÄ™cie:`, false, true, [{
                        name: data.image_file.filename,
                        mime_type: "image/png",
                        data: data.image_file.data
                    }]);
                } 
                else if (data.pdf_file) {
                    addMessageToChat(`Oto TwÃ³j plik PDF: ${data.pdf_file.filename}.`, false, false);
                    downloadPdfFromBase64(data.pdf_file.filename, data.pdf_file.data);
                } 
                else if (data.generated_text) {
                    const assistantText = data.generated_text;
                    const fileMatch = assistantText.match(/\[FILE:([^\]]+)\]([\s\S]*)\[\/FILE\]/);
                    const imgMatch = assistantText.match(/\[IMG\](.*?)\[\/IMG\]/);

                    if (fileMatch) {
                        addMessageToChat(assistantText, false, true, null, true);
                        downloadFile(fileMatch[1], fileMatch[2]);
                    } else if (imgMatch && imgMatch[1]) {
                        addMessageToChat(assistantText, false, true, null, true);
                        generateImage(imgMatch[1]);
                    } else {
                        addMessageToChat(assistantText, false);
                        speak(assistantText);
                    }
                }
            } catch (error) {
                addMessageToChat(`BÅ‚Ä…d: ${error.message}`, false, false);
                console.error("BÅ‚Ä…d handleSubmit:", error);
            } finally {
                // --- NOWA LOGIKA: ZAWSZE USUÅƒ WSKAÅ¹NIK ---
                const bubbleToRemove = document.getElementById('thinking-bubble');
                if (bubbleToRemove) {
                    bubbleToRemove.remove();
                }
            }
        }
        
        function copyCode(button) { /* ... (bez zmian) ... */ }

        function downloadFile(fileName, content) { /* ... (bez zmian) ... */ }

        function addMessageToChat(text, isUser, addToHistory = true, attachments = null, isHidden = false) {
            if (addToHistory) {
                const historyEntry = { role: isUser ? 'user' : 'assistant', content: text };
                if (attachments) { historyEntry.attachments = attachments; }
                if (isHidden) historyEntry.isHidden = true;
                conversationHistory.push(historyEntry);
            }
            if (isHidden) return;
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${isUser ? 'user' : 'assistant'}-message`;
            const cleanText = text.replace(/\[\/?(PL|EN|DE|FR|ES|IMG|FILE:.+?|PDF:.+?|EDIT_IMAGE:.+?|COMPOSITE_IMAGE:.+?)\]/gi, '');

            const fileMatch = text.match(/\[FILE:([^\]]+)\]([\s\S]*)\[\/FILE\]/);
            const codeMatch = text.match(/```(\w*)\n([\s\S]*)```/);

            if (fileMatch) {
                messageBubble.innerHTML = `<p>PrzygotowaÅ‚em dla Ciebie plik:</p><a href="#" class="download-file-button" onclick="event.preventDefault(); downloadFile('${fileMatch[1]}', \`${fileMatch[2].replace(/`/g, '\\`')}\`)">${fileMatch[1]}</a>`;
            } else if (codeMatch) {
                const lang = codeMatch[1] || 'plaintext';
                const code = codeMatch[2];
                messageBubble.innerHTML = `<pre class="language-${lang}"><button class="copy-code-button" onclick="copyCode(this)">Kopiuj</button><code>${code.replace(/</g, "<").replace(/>/g, ">")}</code></pre>`;
                if (window.Prism) Prism.highlightAllUnder(messageBubble);
            } else if (attachments && attachments[0] && attachments[0].mime_type.startsWith('image/')) {
                const image = document.createElement('img');
                image.src = `data:${attachments[0].mime_type};base64,${attachments[0].data}`;
                image.alt = cleanText || 'ZaÅ‚Ä…czony obraz';
                messageBubble.appendChild(image);
                if (cleanText) {
                    const textNode = document.createElement('p');
                    textNode.innerText = cleanText;
                    messageBubble.appendChild(textNode);
                }
            } else {
                if (cleanText) messageBubble.innerText = cleanText;
            }
            if (messageBubble.innerHTML || messageBubble.innerText) {
                messageList.appendChild(messageBubble);
                messageList.scrollTop = messageList.scrollHeight;
            }
        }
        
        // ... (reszta kodu bez zmian, w tym obsÅ‚uga mikrofonu i reszta event listenerÃ³w) ...

        chatForm.addEventListener('submit', (e) => { e.preventDefault(); handleSubmit(false); });
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            let isListening = false;
            micButton.addEventListener('click', () => { if (!sessionStorage.getItem('isAuthenticated')) return; if (isListening) { recognition.stop(); } else { userInput.value = ''; recognition.lang = 'pl-PL'; recognition.start(); } });
            recognition.onstart = () => { isListening = true; micButton.classList.add('is-listening'); };
            recognition.onend = () => { isListening = false; micButton.classList.remove('is-listening'); if (userInput.value.trim()){ handleSubmit(false); } };
            recognition.onresult = (event) => { let interim_transcript = ''; let final_transcript = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { const transcript = event.results[i][0].transcript; if (event.results[i].isFinal) { final_transcript += transcript; } else { interim_transcript += transcript; } } userInput.value = final_transcript + interim_transcript; };
            recognition.onerror = (event) => { console.error("BÅ‚Ä…d rozpoznawania mowy:", event.error); isListening = false; micButton.classList.remove('is-listening'); };
        } else {
            micButton.style.display = 'none';
        }
        
        updateTtsToggleIcon();
        checkAuthentication();
    </script>
</body>
</html>
