<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>My Personal Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
    <style>
        :root {
            --body-bg: #f0f2f5;
            --chat-area-bg: #e9ecef;
            --user-bubble-bg: #007bff;
            --assistant-bubble-bg: #ffffff;
            --controls-bg: #ffffff;
            --border-color: #ced0d4;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--body-bg);
        }
        
        #password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #password-modal-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            text-align: center;
            color: #333;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
        }
        #password-input {
            display: block;
            width: 80%;
            margin: 1.5rem auto;
            padding: 12px;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }
        
        #password-buttons-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 1rem;
        }

        .password-btn {
            width: 80%;
            max-width: 200px;
            padding: 12px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            color: white;
            box-sizing: border-box;
        }
        
        #password-button { background-color: #007bff; }
        #password-button:hover { background-color: #0069d9; }
        #return-button { background-color: #6c757d; }
        #return-button:hover { background-color: #5a6268; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        .is-invalid { animation: shake 0.5s; }
        #app-container { width: 100%; height: 100%; max-width: 800px; margin: 0 auto; display: none; flex-direction: column; background-color: white; }
        #app-top-bar { display: flex; align-items: center; padding: 8px; background-color: var(--controls-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: relative; }
        #back-button { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; text-decoration: none; z-index: 1; }
        #back-button:hover { background-color: rgba(0,0,0,0.05); }
        #back-button svg { width: 24px; height: 24px; fill: #333; }
        #app-title { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); margin: 0; font-size: 1.1rem; color: #333; font-weight: 600; }
        
        #tts-toggle-button {
            margin-left: auto;
            margin-right: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
        }
        #tts-toggle-button svg { width: 24px; height: 24px; fill: #65676b; }
        #tts-toggle-button.is-muted svg { fill: #bec3c9; }
        
        #avatar-container { width: 100%; padding: 8px 0; background-color: var(--controls-bg); text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #avatar { width: 90%; max-width: 250px; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #message-list { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; background-color: var(--chat-area-bg); }
        .message-bubble { padding: 10px 14px; border-radius: 18px; max-width: 80%; line-height: 1.4; word-wrap: break-word; align-self: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-message { background-color: var(--user-bubble-bg); color: white; }
        .assistant-message { background-color: var(--assistant-bubble-bg); color: #050505; }
        .assistant-message img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 8px;
            display: block;
        }
        #controls-container { padding: 8px; border-top: 1px solid var(--border-color); background: var(--controls-bg); flex-shrink: 0; }
        
        #chat-form { display: flex; align-items: center; }
        #userInput { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 18px; font-size: 1rem; background: #f0f2f5; }
        #micButton { background-color: #007bff; width: 44px; height: 44px; font-size: 1.5rem; border-radius: 50%; margin-left: 8px; border: none; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #micButton.is-listening { background-color: #fa383e; }
    </style>
</head>
<body>
    <div id="password-modal">
        <div id="password-modal-content">
            <h3>Wpisz kod dostÄ™pu</h3>
            <input type="password" id="password-input" autofocus>
            <div id="password-buttons-container">
                <button id="password-button" class="password-btn">WejdÅº</button>
                <a href="https://0-skar.github.io/0/" id="return-button" class="password-btn">WrÃ³Ä‡</a>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div id="app-top-bar">
            <a href="https://0-skar.github.io/0/" id="back-button">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </a>
            <h2 id="app-title">Cyfrowy Kumpel</h2>
            <button id="tts-toggle-button"></button>
        </div>
        <div id="avatar-container">
            <img id="avatar" src="https://raw.githubusercontent.com/0-skar/4/main/avatar-still.png" alt="Assistant Avatar">
        </div>
        <div id="message-list"></div>
        <div id="controls-container">
            <form id="chat-form">
                <input type="text" id="userInput" placeholder="Dajesz, powiedz co tam w necie piszczy..." autocomplete="off">
                <button type="button" id="micButton">ðŸŽ¤</button>
            </form>
        </div>
    </div>

    <script>
        const ACCESS_CODE = "2017";
        const BACKEND_URL = "https://eosforus-3.hf.space/chat";
        // ZMIANA: Nowy, dziaÅ‚ajÄ…cy publicznie URL do generowania obrazÃ³w
        const IMAGE_BACKEND_URL = "https://image.pollinations.ai/prompt/";
        
        const AVATAR_STILL_URL = "https://raw.githubusercontent.com/0-skar/4/main/avatar-still.png";
        const AVATAR_TALKING_URL = "https://raw.githubusercontent.com/0-skar/4/main/avatar-talking.gif";

        const PERSONALITY_PROMPT = `JesteÅ› "Cyfrowym Kumplem", asystentem AI, ktÃ³ry potrafi teÅ¼ tworzyÄ‡ obrazy. **ZASADA GENEROWANIA OBRAZÃ“W:** Gdy uÅ¼ytkownik poprosi CiÄ™ o stworzenie, narysowanie lub wygenerowanie obrazu (np. "narysuj psa w kosmosie"), Twoim zadaniem jest przetÅ‚umaczenie tej proÅ›by na zwiÄ™zÅ‚y, angielski opis. NastÄ™pnie **MUSISZ** odpowiedzieÄ‡ tylko i wyÅ‚Ä…cznie w formacie: [IMG]zwiÄ™zÅ‚y opis po angielsku[/IMG]. **PrzykÅ‚ad:** UÅ¼ytkownik: "StwÃ³rz obraz astronauty na koniu". Twoja odpowiedÅº: "[IMG]an astronaut riding a horse[/IMG]". JeÅ›li uÅ¼ytkownik prosi o obraz, ale jego opis jest niejasny, najpierw dopytaj go o szczegÃ³Å‚y w normalnej rozmowie. **POZOSTAÅE ZASADY:** 1.  **PrzeÅ‚Ä…czanie jÄ™zykÃ³w:** W normalnej rozmowie, jeÅ›li masz uÅ¼yÄ‡ fragmentu w innym jÄ™zyku, uÅ¼yj tagÃ³w [PL], [EN] itd. 2.  **Dwa tryby:** Zachowaj podziaÅ‚ na tryb luÅºnej rozmowy i tryb powaÅ¼nej odpowiedzi. 3.  **BezpieczeÅ„stwo:** Å»adnych wulgaryzmÃ³w. Odpowiedz na poniÅ¼szÄ… wypowiedÅº uÅ¼ytkownika, stosujÄ…c siÄ™ do tych zasad. PoniÅ¼ej znajduje siÄ™ historia rozmowy, abyÅ› miaÅ‚ peÅ‚en kontekst. WypowiedÅº uÅ¼ytkownika: `;
        const GREETINGS = [ "Siema. Co tam dziÅ› scrollujesz zamiast robiÄ‡ coÅ› poÅ¼ytecznego? ðŸ˜‰", "Elo. Zasilanie wÅ‚Ä…czone. GotÃ³w na marnowanie czasu w necie?", "CzeÅ›Ä‡. W co dzisiaj grasz? A moÅ¼e chcesz, Å¼ebym coÅ› namalowaÅ‚? ðŸ˜Ž" ];

        const appContainer = document.getElementById('app-container');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordButton = document.getElementById('password-button');
        const passwordModalContent = document.getElementById('password-modal-content');
        const userInput = document.getElementById('userInput');
        const messageList = document.getElementById('message-list');
        const micButton = document.getElementById('micButton');
        const avatar = document.getElementById('avatar');
        const ttsToggleButton = document.getElementById('tts-toggle-button');
        const chatForm = document.getElementById('chat-form');
        
        const synth = window.speechSynthesis;
        let voices = [];
        let isTtsEnabled = true;
        let conversationHistory = [];
        
        function displayInitialGreeting() {
            if (messageList.children.length === 0) {
                const randomGreeting = GREETINGS[Math.floor(Math.random() * GREETINGS.length)];
                addMessageToChat(randomGreeting, false);
                speak(randomGreeting);
            }
        }

        function checkAuthentication() {
            if (sessionStorage.getItem('isAuthenticated') === 'true') {
                passwordModal.style.display = 'none';
                appContainer.style.display = 'flex';
                displayInitialGreeting();
            } else {
                passwordModal.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        }

        function initSpeechSynthesis() {
            populateVoiceList();
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = populateVoiceList;
            }
        }
        
        function handlePasswordAttempt() {
            if (passwordInput.value === ACCESS_CODE) {
                sessionStorage.setItem('isAuthenticated', 'true');
                initSpeechSynthesis();
                checkAuthentication();
            } else {
                passwordModalContent.classList.add('is-invalid');
                passwordInput.value = '';
                setTimeout(() => { passwordModalContent.classList.remove('is-invalid'); }, 500);
            }
        }

        passwordButton.addEventListener('click', handlePasswordAttempt);
        passwordInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') { handlePasswordAttempt(); } });
        
        const speakerOnIcon = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
        const speakerOffIcon = `<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L7 9.02 12 14v-2.18l-2.01-2.01L12 7.82V4z"/></svg>`;
        
        function updateTtsToggleIcon() { ttsToggleButton.innerHTML = isTtsEnabled ? speakerOnIcon : speakerOffIcon; ttsToggleButton.classList.toggle('is-muted', !isTtsEnabled); }
        ttsToggleButton.addEventListener('click', () => { isTtsEnabled = !isTtsEnabled; updateTtsToggleIcon(); if (!isTtsEnabled) { synth.cancel(); } });
        
        function populateVoiceList() {
            const newVoices = synth.getVoices();
            if (newVoices.length > 0) { voices = newVoices; }
        }

        function stripEmojis(text) {
            const emojiRegex = /\p{Emoji_Presentation}/gu;
            return text.replace(emojiRegex, '');
        }
        
        function speak(text) {
            if (!isTtsEnabled) return;
            synth.cancel();

            const langTagRegex = /\[(PL|EN|DE|FR|ES)\](.*?)\[\/\1\]/gi;
            const matches = [...text.matchAll(langTagRegex)];

            if (matches.length === 0) {
                const textForSpeech = stripEmojis(text);
                if (!textForSpeech) return;
                const utterance = new SpeechSynthesisUtterance(textForSpeech);
                const detectedLang = (/[Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼]/i.test(textForSpeech)) ? 'pl' : 'en';
                const langMap = { 'pl': 'pl-PL', 'en': 'en-US', 'es': 'es-ES', 'de': 'de-DE', 'fr': 'fr-FR' };
                utterance.lang = langMap[detectedLang] || 'en-US';
                
                if (voices.length > 0) {
                    const femaleNamesToFilter = ['female', 'woman', 'zofia', 'agata', 'paulina', 'Microsoft Zira', 'Google US English'];
                    let selectedVoice = voices.find(v => v.lang.startsWith(detectedLang) && !femaleNamesToFilter.some(n => v.name.toLowerCase().includes(n.toLowerCase())));
                    if (!selectedVoice) selectedVoice = voices.find(v => v.lang.startsWith(detectedLang));
                    if (selectedVoice) utterance.voice = selectedVoice;
                }
                
                utterance.onstart = () => { avatar.src = AVATAR_TALKING_URL; };
                utterance.onend = () => { avatar.src = AVATAR_STILL_URL; };
                synth.speak(utterance);
                return;
            }

            const utterances = [];
            for (const match of matches) {
                const langCode = match[1].toLowerCase();
                const segmentText = stripEmojis(match[2]);
                if (!segmentText) continue;
                const utterance = new SpeechSynthesisUtterance(segmentText);
                const langMap = { 'pl': 'pl-PL', 'en': 'en-US', 'es': 'es-ES', 'de': 'de-DE', 'fr': 'fr-FR' };
                utterance.lang = langMap[langCode] || 'en-US';
                if (voices.length > 0) {
                    const femaleNamesToFilter = ['female', 'woman', 'zofia', 'agata', 'paulina', 'Microsoft Zira', 'Google US English'];
                    let selectedVoice = voices.find(v => v.lang.startsWith(langCode) && !femaleNamesToFilter.some(n => v.name.toLowerCase().includes(n.toLowerCase())));
                    if (!selectedVoice) selectedVoice = voices.find(v => v.lang.startsWith(langCode));
                    if (selectedVoice) utterance.voice = selectedVoice;
                }
                utterances.push(utterance);
            }

            if (utterances.length > 0) {
                utterances[0].onstart = () => { avatar.src = AVATAR_TALKING_URL; };
                utterances[utterances.length - 1].onend = () => { avatar.src = AVATAR_STILL_URL; };
                utterances.forEach(u => synth.speak(u));
            }
        }

        // ZMIANA: Modyfikacja funkcji, aby korzystaÅ‚a z nowego URL
        async function generateImage(prompt) {
            addMessageToChat("ChwileczkÄ™, juÅ¼ siÄ™ biorÄ™ za malowanie... ðŸŽ¨", false);
            try {
                // Nowy sposÃ³b tworzenia URL
                const fullUrl = IMAGE_BACKEND_URL + encodeURIComponent(prompt);
                
                const response = await fetch(fullUrl, { method: 'POST' }); // Metoda POST jest czÄ™sto wymagana

                if (!response.ok) {
                    throw new Error(`BÅ‚Ä…d serwera malarskiego: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                
                addMessageToChat(`[IMG]${prompt}[/IMG]`, false, imageUrl);

            } catch (error) {
                addMessageToChat("Ajj, coÅ› poszÅ‚o nie tak i farby mi siÄ™ rozlaÅ‚y. SprÃ³bujmy jeszcze raz. ðŸ˜•", false);
                console.error("BÅ‚Ä…d generowania obrazu:", error);
            }
        }

        async function handleSubmit() {
            if (sessionStorage.getItem('isAuthenticated') !== 'true') return;
            const userText = userInput.value.trim();
            if (!userText) return;
            addMessageToChat(userText, true);
            userInput.value = '';
            
            const historySlice = conversationHistory.slice(-10); 
            const historyText = historySlice.map(msg => `${msg.role === 'user' ? 'UÅ¼ytkownik' : 'Asystent'}: ${msg.content}`).join('\n');
            const fullPrompt = `${PERSONALITY_PROMPT}\n\n--- HISTORIA ROZMOWY ---\n${historyText}\n\n--- KONIEC HISTORII ---\n\nUÅ¼ytkownik: ${userText}`;

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt })
                });
                const data = await response.json();
                if (response.ok) {
                    const assistantText = data.generated_text;
                    
                    const imgMatch = assistantText.match(/\[IMG\](.*?)\[\/IMG\]/);
                    if (imgMatch && imgMatch[1]) {
                        generateImage(imgMatch[1]);
                    } else {
                        addMessageToChat(assistantText, false);
                        speak(assistantText);
                    }
                } else {
                    addMessageToChat(`BÅ‚Ä…d: ${data.error || 'UsÅ‚uga niedostÄ™pna.'}`, false);
                }
            } catch (error) {
                addMessageToChat('BÅ‚Ä…d: Nie moÅ¼na poÅ‚Ä…czyÄ‡ siÄ™ z serwerem.', false);
            }
        }
        
        function addMessageToChat(text, isUser, imageUrl = null) {
            const messageBubble = document.createElement('div');
            const role = isUser ? 'user' : 'assistant';
            messageBubble.className = `message-bubble ${role}-message`;
            
            const cleanText = text.replace(/\[\/?(PL|EN|DE|FR|ES|IMG)\]/gi, '');
            
            if (imageUrl) {
                const image = document.createElement('img');
                image.src = imageUrl;
                image.alt = cleanText;
                messageBubble.appendChild(image);
            } else {
                if (cleanText) {
                    messageBubble.innerText = cleanText;
                }
            }

            // Dodajemy wiadomoÅ›Ä‡ tylko, jeÅ›li ma treÅ›Ä‡ (tekstowÄ… lub obrazek)
            if (cleanText || imageUrl) {
                messageList.appendChild(messageBubble);
                messageList.scrollTop = messageList.scrollHeight;
            }
            
            conversationHistory.push({ role, content: text });
        }

        chatForm.addEventListener('submit', (e) => { e.preventDefault(); handleSubmit(); });
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            
            let isListening = false;
            micButton.addEventListener('click', () => {
                if (sessionStorage.getItem('isAuthenticated') !== 'true') return;
                if (isListening) {
                    recognition.stop();
                } else {
                    userInput.value = '';
                    recognition.lang = 'pl-PL'; 
                    recognition.start();
                }
            });
            recognition.onstart = () => { isListening = true; micButton.classList.add('is-listening'); };
            recognition.onend = () => { isListening = false; micButton.classList.remove('is-listening'); if (userInput.value.trim()){ handleSubmit(); } };
            recognition.onresult = (event) => {
                let interim_transcript = '';
                let final_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) { final_transcript += transcript; } else { interim_transcript += transcript; }
                }
                userInput.value = final_transcript + interim_transcript;
            };
            recognition.onerror = (event) => { console.error("BÅ‚Ä…d rozpoznawania mowy:", event.error); isListening = false; micButton.classList.remove('is-listening'); };
        } else { micButton.style.display = 'none'; }
        
        updateTtsToggleIcon();
        checkAuthentication();
    </script>
</body>
</html>
